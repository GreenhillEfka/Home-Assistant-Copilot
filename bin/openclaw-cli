#!/bin/bash
# OpenClaw CLI - Model and Service Manager
# Usage: ./openclaw-cli <command>

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Colors for output
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Source model configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/config/models.sh"

# Commands
case "${1:-status}" in
    status)
        echo "=== OpenClaw Status ==="
        echo ""
        echo "Server: $OLLAMA_HOST"
        echo ""
        echo "Models:"
        curl -s "${OLLAMA_HOST}/api/tags" 2>/dev/null | grep -o '"name":"[^"]*"' | sed 's/"name":"//;s/"//g' | head -10 || log_warn "Cannot connect to server"
        echo ""
        echo "API Access:"
        check_api_available >/dev/null && log_info "Remote Ollama online" || log_warn "Remote Ollama offline"
        ;;
    
    test)
        test_all
        ;;
    
    models)
        show_config
        ;;
    
    use)
        # Set which model to use
        local model="${2:-deepseek-r1:14b}"
        export DEFAULT_MODEL="$model"
        log_info "Default model set to: $model"
        ;;
    
    api-status)
        local status=$(check_api_available)
        if [ "$status" = "true" ]; then
            log_info "Cloud APIs are available"
            echo "Primary model: $(get_model true)"
        else
            log_warn "Cloud APIs are not available"
            echo "Using fallback: $(get_model false)"
        fi
        ;;
    
    ollama-status)
        if curl -s --max-time 3 "${OLLAMA_HOST}/api/tags" >/dev/null 2>&1; then
            log_info "Remote Ollama is online: $OLLAMA_HOST"
            curl -s "${OLLAMA_HOST}/api/tags" | grep -o '"name":"[^"]*"' | sed 's/"name":"//;s/"//g' | head -5
        else
            log_error "Cannot connect to: $OLLAMA_HOST"
        fi
        ;;
    
    help|*)
        echo "OpenClaw CLI - Model and Service Manager"
        echo ""
        echo "Commands:"
        echo "  status        Show current status"
        echo "  test          Test all models"
        echo "  models        Show model configuration"
        echo "  use <model>   Set default model"
        echo "  api-status    Check API availability"
        echo "  ollama-status Check Ollama service"
        echo "  help          Show this help"
        echo ""
        ;;
esac
