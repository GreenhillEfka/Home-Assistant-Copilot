# Copilot-Core — Code-Audit Februar 2026

> Vollständiges Audit siehe: `ai-home-copilot-ha/docs/AUDIT_2026_02.md`
> Dieses Dokument enthält die Core-spezifischen Findings.

---

## Kritische Thread-Safety Probleme

Der Core läuft als **Flask + Waitress (Multi-Threaded WSGI)**. Alle
folgenden Probleme betreffen **Race Conditions** bei parallelen Requests.

### 1. Unsafe Singleton-Pattern (8 Stellen)

**Betroffen:**
- `brain_graph/provider.py:14-30` — BrainGraphService
- `api/v1/events.py:13-26` — EventStore
- `api/v1/candidates.py:13-24` — CandidateStore
- `api/v1/mood.py:11-17` — Mood-Service

**Problem:** Lazy-Loading ohne Lock → zwei Threads können gleichzeitig
neue Instanzen erstellen.

**Fix:**
```python
import threading

_lock = threading.Lock()
_SVC: BrainGraphService | None = None

def get_graph_service() -> BrainGraphService:
    global _SVC
    if _SVC is not None:
        return _SVC
    with _lock:
        if _SVC is not None:  # Double-checked locking
            return _SVC
        _SVC = BrainGraphService(...)
        return _SVC
```

### 2. Ungeschützte Datenstrukturen (4 Stellen)

**Betroffen:**
- `brain_graph/service.py:96-309` — nodes/edges Dicts
- `storage/events.py:106-210` — _cache, _seen, _by_key
- `storage/candidates.py:75-142` — interne Dicts
- `api/v1/dev.py:87-130` — _DEV_LOG_CACHE Liste
- `api/v1/graph_ops.py:23-44` — _IDEM_CACHE Dict

**Problem:** `BrainGraphStore` hat bereits ein `_lock` Attribut (store.py:24),
wird aber **nirgends verwendet**.

**Fix:** Alle Lese-/Schreibzugriffe auf shared State mit Lock schützen.

### 3. Version-Mismatch

- `config.json:5` → `"version": "0.2.7"`
- `app.py:19` → `os.environ.get("COPILOT_VERSION", "0.2.5")`

**Fix:** Default in app.py auf `"0.2.7"` aktualisieren.

### 4. Stille Fehlerbehandlung

- `api/v1/mood.py:20-27` — alle Exceptions geschluckt
- `main.py:18-22` — Config-Fehler ignoriert

**Fix:** `logging.warning()` bei Exception hinzufügen.

---

## Priorität

| Prio | Aufgabe | Geschätzt |
|------|---------|-----------|
| 1 | Thread-safe Singletons | Klein — Pattern einmal, 8x anwenden |
| 2 | Locks für Datenstrukturen | Mittel — bestehenden `_lock` nutzen |
| 3 | Version-Mismatch | Trivial — eine Zeile |
| 4 | Error Logging | Klein — 2-3 Stellen |
